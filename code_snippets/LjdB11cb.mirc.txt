ON *:TEXT:*:#: {
Â  if ($strip($1) == $+($pref,peticiones)) { 
Â  Â  if (!%database) || (%database == $null) { error No existe conexiÃ³n con la base de datos MySQL }
Â 
Â  Â  if ($strip($2) == $null) { msg # Sintaxis: $sintaxis(peticiones) | msg # $sintaxis(peticiones,error) | halt }
Â 
Â  Â  if ($strip($2) == ON) { 
Â 
Â  Â  Â  set %PETICIONES.tabla modulos
Â  Â  Â  set %PETICIONES.item estado 
Â  Â  Â  set %PETICIONES.dato 1
Â  Â  Â  set %PETICIONES.is =
Â  Â  Â  set %PETICIONES.s $chr(9)
Â 
Â  Â  Â  if ($dbGet(%PETICIONES.tabla)) { 
Â 
Â  Â  Â  Â  if ($dbResults) { 
Â 
Â  Â  Â  Â  Â  set %PETICIONES.id_modulo $hget(db_results,id_modulo)
Â  Â  Â  Â  Â  set %PETICIONES.modulo $hget(db_results,modulo)
Â  Â  Â  Â  Â  set %PETICIONES.estado $hget(db_results,estado) 
Â 
Â  Â  Â  Â  Â  if (%PETICIONES.modulo == peticiones) && (%PETICIONES.estado == %PETICIONES.dato) { 
Â 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Lo siento $theme(&primary;,$nick) pero las $theme(&underline;,peticiones) ya estÃ¡n $+($theme(&success;,abiertas),$chr(46))
Â  Â  Â  Â  Â  Â  halt
Â 
Â  Â  Â  Â  Â  }
Â 
Â 
Â  Â  Â  Â  Â  if ($dbUpdate(%PETICIONES.tabla,%PETICIONES.item,%PETICIONES.dato,id_modulo = %PETICIONES.id_modulo)) {
Â 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) $theme(&primary;,%locutor) Se han abierto las $theme(&underline;,peticiones) a peticiÃ³n de $theme(&primary;,$nick)
Â  Â  Â  Â  Â  Â  amsg $theme([&warning;]:,PETICIONES) Desde este momento puedes solicitar tu tema/dedicatoria escribiendo $theme(&primary;,$+($pref,$upper(peticion)) <artista> <canciÃ³n> <dedicada a "usuario(s)"> <mensaje de dedicatoria>)
Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  if ($strip($2) == OFF) {
Â  Â  Â  set %PETICIONES.tabla modulos
Â  Â  Â  set %PETICIONES.item estado
Â  Â  Â  set %PETICIONES.dato 0
Â  Â  Â  set %PETICIONES.is =
Â  Â  Â  set %s $chr(9)
Â  Â  Â  if ($dbGet(%PETICIONES.tabla)) { 
Â  Â  Â  Â  if ($dbResults) { 
Â  Â  Â  Â  Â  set %PETICIONES.id_modulo $hget(db_results,id_modulo)
Â  Â  Â  Â  Â  set %PETICIONES.modulo $hget(db_results,modulo)
Â  Â  Â  Â  Â  set %PETICIONES.estado $hget(db_results,estado)
Â  Â  Â  Â  Â  if (%PETICIONES.modulo == peticiones) && (%PETICIONES.estado == %PETICIONES.dato) { 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Lo siento $theme(&primary;,$nick) pero las $theme(&underline;,peticiones) ya estÃ¡n cerradas.
Â  Â  Â  Â  Â  Â  halt
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if ($dbUpdate(%PETICIONES.tabla,%PETICIONES.item,%PETICIONES.dato,id_modulo = %PETICIONES.id_modulo)) {
Â  Â  Â  Â  Â  Â  ;success Desde este momento las peticiones estÃ¡n cerradas. 
Â  Â  Â  Â  Â  Â  amsg $theme([&warning;]:,PETICIONES) Desde este momento las $theme(&underline;,peticiones) estÃ¡n $+($theme(&danger;,cerradas),$chr(46))
Â  Â  Â  Â  Â  Â  unset %PETICIONES.*
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  $mysql_free(%database)
Â  Â  }
Â 
Â  Â  if ($strip($2) == INFO) { 
Â  Â  Â  if (!$3) { 
Â  Â  Â  Â  msg # Sintaxis: $sintaxis(peticiones,info) 
Â  Â  Â  Â  msg # $sintaxis(peticiones,error) 
Â  Â  Â  Â  halt 
Â  Â  Â  }
Â  Â  Â  if ($3 !isnum) {
Â  Â  Â  Â  msg # Lo siento $nick pero debes escribir un ID vÃ¡lido para poder procesar la informaciÃ³n.
Â  Â  Â  Â  halt
Â  Â  Â  }
Â  Â  Â  else { 
Â  Â  Â  Â  set %PETICIONES.tabla peticiones
Â  Â  Â  Â  set %PETICIONES.radio $isStationID
Â  Â  Â  Â  if ($dbGet(%PETICIONES.tabla)) { 
Â  Â  Â  Â  Â  if ($dbResults) { 
Â 
Â  Â  Â  Â  Â  Â  set %PETICIONES.id_peticion $hget(db_results,id_peticion)
Â  Â  Â  Â  Â  Â  set %PETICIONES.radio $hget(db_results,radio)
Â  Â  Â  Â  Â  Â  set %PETICIONES.locutor $hget(db_results,locutor)
Â  Â  Â  Â  Â  Â  set %PETICIONES.locutor_transferido $hget(db_results,locutor_transferido)
Â  Â  Â  Â  Â  Â  set %PETICIONES.artista $hget(db_results,artista)
Â  Â  Â  Â  Â  Â  set %PETICIONES.cancion $hget(db_results,cancion)
Â  Â  Â  Â  Â  Â  set %PETICIONES.solicitado $hget(db_results,solicitado)
Â  Â  Â  Â  Â  Â  set %PETICIONES.DATE $hget(db_results,DATE)
Â  Â  Â  Â  Â  Â  set %PETICIONES.TIME $hget(db_results,TIME)
Â  Â  Â  Â  Â  Â  set %PETICIONES.mensaje $hget(db_results,mensaje)
Â  Â  Â  Â  Â  Â  set %PETICIONES.estado $hget(db_results,estado)
Â  Â  Â  Â  Â  Â  set %PETICIONES.serial $hget(db_results,serial)
Â 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Mostrando informaciÃ³n de la peticiÃ³n con ID: %PETICIONES.id_peticion $+($chr(123)Serial:,%PETICIONES.serial,$chr(125)) 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Locutor $isUSER(%PETICIONES.locutor)
Â 
Â  Â  Â  Â  Â  Â  if (%PETICIONES.locutor_transferido) { 
Â  Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) PeticiÃ³n transferida a $isUSER(%PETICIONES.locutor_transferido)
Â  Â  Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Fecha: $theme(&primary;,%PETICIONES.DATE) Hora: $theme(&primary;,%PETICIONES.TIME)
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Artista: $theme(&primary;,%PETICIONES.artista) - $theme(&primary;,%PETICIONES.cancion)
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Solicitada por: $theme(&primary;,%PETICIONES.solicitado)
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Mensaje de solicitud: %PETICIONES.mensaje
Â 
Â  Â  Â  Â  Â  Â  if (%PETICIONES.estado == realizada) { set %PETICIONES.estado $theme(&success;,$hget(db_results,estado)) }
Â  Â  Â  Â  Â  Â  elseif (%PETICIONES.estado == pendiente) { set %PETICIONES.estado $theme(&danger;,$hget(db_results,estado)) } 
Â  Â  Â  Â  Â  Â  elseif (%PETICIONES.estado == ignorada) { }
Â 
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) Estado de la solicitud: %PETICIONES.estado
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES)
Â  Â  Â  Â  Â  Â  msg %lc_locutores $theme([&warning;]:,PETICIONES) - Fin de la informaciÃ³n - 
Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  }
Â  if ($strip($2) == TRANSFER) { 
Â  Â  if (!$3) { msg # Sintaxis: $sintaxis(peticiones,transfer) | msg # $sintaxis(peticiones,error) | halt }
Â  Â  if ($strip($3)) {
Â 
Â  Â  Â  set %m.sql $mysql_connect($config(mysql,hostname), $config(mysql,username), $config(mysql,password))
Â 
Â  Â  Â  else if ($mysql_select_db(%m.sql, $config(mysql,database))) {
Â 
Â  Â  Â  Â  var %sql = SELECT * FROM `peticiones` WHERE `radio` = $m.sqlq($radio) AND `locutor` = $m.sqlq($nick)
Â  Â  Â  Â  var %res = $mysql_query(%m.sql, %sql)
Â  Â  Â  Â  if (%res) { 
Â  Â  Â  Â  Â  while ($mysql_fetch_row(%res, row, $mysql_assoc)) { 
Â  Â  Â  Â  Â  Â  set %id_peticion $hget(row, id_peticion)
Â  Â  Â  Â  Â  Â  set %locutor $hget(row, locutor)
Â  Â  Â  Â  Â  Â  set %locutor_transferido $hget(row, locutor_transferido) 
Â  Â  Â  Â  Â  Â  set %estado $hget(row, estado)
Â  Â  Â  Â  Â  Â  set %transferida $hget(row, transferida)
Â  Â  Â  Â  Â  Â  if (%estado == pendiente) { }
Â  Â  Â  Â  Â  Â  if (%estado == ignorada) { }
Â  Â  Â  Â  Â  Â  if (%estado == realizada) { }
Â  Â  Â  Â  Â  Â  if ($3 == %id_peticion) { Â 
Â  Â  Â  Â  Â  Â  Â  if ($4 == %locutor) { msg # Lo siento, pero la peticiÃ³n con ID 10 $+ $3 $+  ya pertenece al locutor 12 $+ %locutor  $+  | halt } Â  Â  
Â 
Â  Â  Â  Â  Â  Â  Â  if (%transferida == SI) { 
Â  Â  Â  Â  Â  Â  Â  Â  msg # Lo siento pero la peticion con ID 10 $+ $3 $+  ya habÃ­a sido transferida a 12 $+ %locutor_transferido $+  $+ .
Â  Â  Â  Â  Â  Â  Â  }
Â 
Â  Â  Â  Â  Â  Â  Â  if (%transferida == NO) { 
Â  Â  Â  Â  Â  Â  Â  Â  var %sql = UPDATE `peticiones` SET `locutor_transferido` = $m.sqlq($4) $+ , `transferida` = 'SI' $+ , `estado` = 'pendiente' WHERE `peticiones`.`id_peticion` = $m.sqlq($3)
Â  Â  Â  Â  Â  Â  Â  Â  noop $mysql_query(%m.sql, %sql)
Â  Â  Â  Â  Â  Â  Â  Â  msg %config.debug PeticiÃ³n con ID 10 $+ $3 $+  transferida correctamente al locutor 12 $+ $4 $+  $+ .
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  $mysql_free(%m.sql)
Â  Â  Â  }
Â  Â  }
Â  Â  if ($strip($2) == COUNT) {
Â  Â  Â  if (!$3) { 
Â  Â  Â  Â  set %m.sql $mysql_connect($config(mysql,hostname), $config(mysql,username), $config(mysql,password))
Â  Â  Â  Â  if ($mysql_select_db(%m.sql, $config(mysql,database))) {
Â  Â  Â  Â  Â  var %sql = SELECT COUNT(*) AS `Filas` FROM `peticiones` WHERE radio = $isStationID AND `DATE` = $+($chr(39),$asctime(yyyy-mm-dd),$chr(39))
Â  Â  Â  Â  Â  var %res = $mysql_query(%m.sql, %sql) 
Â  Â  Â  Â  Â  if (%res) { 
Â  Â  Â  Â  Â  Â  while ($mysql_fetch_row(%res, row, $mysql_assoc)) { 
Â  Â  Â  Â  Â  Â  Â  set %filas $hget(row, filas)
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  $mysql_free(%m.sql)
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (%filas == 0) { msg # $bold(PETICIONES COUNT:) 12 $+ $nick $+  Perfecto! No hay peticiones pendientes. }
Â  Â  Â  Â  Â  else { 
Â  Â  Â  Â  Â  Â  msg # $bold(PETICIONES COUNT:) Han solicitado un total de4 %filas $+  dedicatorias el dÃ­a de hoy. 
Â  Â  Â  Â  Â  Â  $mysql_close(%m.sql) Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  else { 
Â  Â  Â  set %m.sql $mysql_connect($config(mysql,hostname), $config(mysql,username), $config(mysql,password))
Â  Â  Â  if ($mysql_select_db(%m.sql, $config(mysql,database))) {
Â 
Â  Â  Â  Â  var %sql = SELECT COUNT(*) AS `Filas` FROM `peticiones` WHERE radio = $isStationID AND `DATE` = $+($chr(39),$asctime(yyyy-mm-dd),$chr(39)) AND `locutor` = $+($chr(39),%locutor,$chr(39))
Â  Â  Â  Â  var %res = $mysql_query(%m.sql, %sql) 
Â  Â  Â  Â  if (%res) { 
Â  Â  Â  Â  Â  while ($mysql_fetch_row(%res, row, $mysql_assoc)) { 
Â  Â  Â  Â  Â  Â  set %filas $hget(row, filas)
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  $mysql_free(%m.sql)
Â  Â  Â  Â  }
Â  Â  Â  Â  msg # $bold(PETICIONES COUNT:) Han solicitado un total de4 %filas $+  dedicatorias el dÃ­a de hoy. 
Â  Â  Â  Â  $mysql_close(%m.sql) Â 
Â  Â  Â  }
Â  Â  }
Â  }
Â  if ($strip($2) == RECORD) { msg # Recolectando datos... RECORD: <datos> }
}